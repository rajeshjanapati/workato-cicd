name: Workato-CICD
on:
  push:
    branches:
      - main  # Adjust this to your main branch name

env:
  DEPLOYMENT_NAME: CICD Push
  Workato_Token: ${{ secrets.WORKATOTOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUBTOKEN }}

jobs:
  Workato-CICD:
    name: Workato-CICD
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:          
      - name: Check out Git repository code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: "${{ secrets.GITHUBTOKEN }}"

      - name: CICD
        shell: pwsh
        run: |
          $env:access_token = "${{ secrets.WORKATOTOKEN }}"
          Invoke-Pester ./scripts.ps1 -Passthru

      - name: Create cicd branch if not exists
        run: |
          git show-ref --verify --quiet refs/heads/cicd || git checkout -b cicd

      - name: Add local files to Git local branch
        run: |
          git config --global user.email "rajeshjanapati@gmail.com"
          git config --global user.name "rajeshjanapati"
          git add .

      - name: Check for delta changes - Git
        id: check_git_changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "Local branch is not up to date with remote_branch. Committing and pushing latest code to Git"
            git commit -a -m "cicd update"

            # Attempt to pull and auto-merge
            if git pull --no-edit --no-rebase origin cicd; then
              echo "Merge successful. Pushing changes."
              git push origin cicd
            else
              echo "Merge conflicts occurred. Please resolve conflicts and commit the changes."
            fi
          else
            echo "Local branch is up to date with Remote branch. No changes to push."
            exit 0
          fi
